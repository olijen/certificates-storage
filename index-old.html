<!DOCTYPE html>
<html>
<head>
	<title></title>
	<!--script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script-->
    <script src="index.js"></script>
    <link rel="stylesheet" href="index.css">
	<style>
		#your-files {
			border: 1px solid #ccc;
		}
	</style>
</head>
<body>

	<div ng-app="cert">
      <h2>Certificates:</h2>
      <div ng-controller="MainController as main">

        <ul class="unstyled">
          <li ng-repeat="(key, value) in main.items">
            <label>
              <button class="btn btn-default" ng-click="main.show(key)">{{key}}</button>
            </label>
          </li>
        </ul>

        
        
        <h3>Details</h3>
        <div id="details">
          <ul class="unstyled">
            <li ng-repeat="(key, value) in main.currentParsedItem">
              <label>
                <span>{{value}}</span>
              </label>
            </li>
          </ul>
        </div>

      </div>
     </div>
     
     <div id="file-upload">
      Drug and drop your .cer file here
     </div>
     <script>

  var target = document.getElementById("file-upload");
  target.addEventListener("dragover", function(event) {
      event.preventDefault();
  }, false);
  target.addEventListener("drop", function(event) {
      event.preventDefault();
      var i = 0,
      files = event.dataTransfer.files,
      len = files.length;
      for (; i < len; i++) {
        var file = files[i];
        console.log("Filename: " + file.name);
        console.log("Type: " + file.type);
        console.log("Size: " + file.size + " bytes");

        var reader = new FileReader();
        reader.onload = (function(theFile) {
          return function(e) {
            var result = e.target.result;
            var asn1 = ASN1.decode(result);
            var oidsValues = getOIDValues(asn1);
            name = prompt('Введите имя сертификата', theFile.name);
            window.localStorage.setItem(name, result);
            //TODO:
            //var view  = new Uint8Array(result);
            //console.log(view);
            };
          }) (file);

          reader.onerror = function(event) {
          console.error("Файл не может быть прочитан! код " + event.target.error.code);
      };
          //TODO:
          //reader.readAsArrayBuffer(file);
          reader.readAsBinaryString(file);  
      }
  }, false);

  function getOIDValues(asn) {
    var oidsValues = [];
    var lastOID = null;

    (function recursive(asn) {
      console.log(asn.typeName() + " >>> " + asn.content());
      
      if (lastOID !== null && asn.getValue() !== false) {
        oidsValues[lastOID] = asn.content();
      }
      if (asn.typeName() === 'OBJECT_IDENTIFIER') {
        if (window.oids[asn.content()] !== undefined) {
          cl(111);
          lastOID = window.oids[asn.content()]['d'];
        }
        else 
          lastOID = asn.content();
      }

      if (asn.sub === null) return;
      for (var i = 0; i < asn.sub.length; i++)
        recursive(asn.sub[i]);
    }) (asn);
  }

     </script>
    <script type="text/javascript" src="oids.js"></script>
    <script type="text/javascript" src="int10.js"></script>
    <script type="text/javascript" src="asn1.js"></script>
    <script type="text/javascript" src="dom.js"></script>
</body>
</html>